```mermaid
flowchart LR
<<<<<<< HEAD
  subgraph Dev["Local-first (KISS today + spans-first two-stage)"]
=======
  subgraph Dev["Local-first (KISS today + Spans-first two-stage)"]
>>>>>>> origin/main
    CLI["CLI (ingest, annotate)"]
    PDF[("PDF")]
    TXT[("Simple TXT")]
    JSONRaw[("JSON (per-chapter raw)")]
<<<<<<< HEAD
      JSONStruct(("Structured JSON (manifest + chapters)"))

  subgraph Anno["Spans-first two-stage Annotation"]
      DialogueAgent["Dialogue Classifier<br/>(Hybrid: Heuristic + AI)"]
  SpeakerAgent["Speaker Attribution"]
  CharDB[("Character DB (optional)")]
    end

=======
    JSONStruct[("Structured JSON (manifest + chapters)")]
    
  subgraph Anno["Spans-first two-stage Annotation"]
      DialogueAgent["Dialogue Classifier<br/>(Hybrid: Heuristic + AI)"]
      SpeakerAgent["Speaker Attribution<br/>(Character Database)"]
      CharDB[("Character DB<br/>(PostgreSQL)")]
    end
    
>>>>>>> origin/main
    Artifacts[("data/clean/<book>/<chapter>.json\n<pdf_stem>_volume.json")]
    Annos[("data/annotations/<book>/<chapter>.jsonl")]
  end

<<<<<<< HEAD
  CLI --> PDF --> TXT --> SectionClassifier --> Classified --> TxtStructured --> JSONStruct --> Artifacts
=======
  CLI --> PDF --> TXT --> JSONRaw --> JSONStruct --> Artifacts
>>>>>>> origin/main
  Artifacts --> DialogueAgent
  DialogueAgent --> SpeakerAgent
  SpeakerAgent <--> CharDB
  SpeakerAgent --> Annos

  subgraph Later["Later (roadmap)"]
    Casting["Casting (character bible)"]
    SSML["SSML Assembly"]
    TTS["TTS (XTTS/Piper)"]
    Stems[("data/stems/…")]
    Renders[("data/renders/<book>/<chapter>.wav")]
    Master[("book_master.wav")]
    Orchestrator["Dagster / LangGraph"]
    DB[("Postgres (JSONB)")]
  end

  CharDB -.integrates.-> DB
  Annos -.-> Casting -.-> SSML -.-> TTS --> Stems --> Renders --> Master
  Orchestrator -.controls.-> JSONStruct
<<<<<<< HEAD
  Orchestrator -.controls.-> Anno
=======
  Orchestrator -.controls.-> Anno
>>>>>>> origin/main
  Orchestrator -.controls.-> TTS

  Artifacts -.sync.-> DB
  Annos -.sync.-> DB
  Renders -.sync.-> DB
<<<<<<< HEAD
      %% Upstream structuring stages (added)
      SectionClassifier["Section Classifier"]
      Classified(("classified/front_matter.json | toc.json |\nchapters_section.json | back_matter.json"))
  TxtStructured["TXT→Structured (paragraphs[])"]
=======
>>>>>>> origin/main
```
