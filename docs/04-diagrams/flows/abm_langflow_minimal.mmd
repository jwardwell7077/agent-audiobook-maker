flowchart TD
  %% 0-based: chapter_index, block_id, utterance_idx (utterance_idx == block_id)
  %% Aggregator restores order by (chapter_id, utterance_idx)

  A[ABM Chapter Loader<br/>chapter_index: 0-based<br/>outputs: blocks_data] --> B

  B[ABM Block Iterator<br/>start_block: 0<br/>yields: current_utterance per run<br/>emits: completion summary] -->|per block| C

  C[ABM Dialogue Classifier<br/>method: heuristic_only, hybrid, llm_enhanced<br/>llm: none, ollama, openai, generic_http] --> D

  D[ABM Speaker Attribution<br/>dialogue: attribute speaker<br/>narration: narrator; low-confidence: best-guess + QA flag] --> E

  B -->|completion| E

  E[ABM Results Aggregator<br/>accumulates per-block results<br/>finalize on completion<br/>sorts by chapter_id, utterance_idx] --> F

  F[ABM Results â†’ Utterances<br/>normalize to utterances schema] --> G

  G[ABM Aggregated JSONL Writer<br/>writes JSONL + .meta.json]

  F -.->|optional| H[ABM Casting Director<br/>assigns voices to utterances for TTS]
