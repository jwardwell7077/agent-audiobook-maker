flowchart LR
  %% Active components wiring (spans-first, pre-SSML)

  %% Style classes
  classDef core fill:#0d47a1,stroke:#0d47a1,color:#fff,stroke-width:2px
  classDef art fill:#546e7a,stroke:#546e7a,color:#fff,stroke-width:2px
  classDef out fill:#1b5e20,stroke:#1b5e20,color:#fff,stroke-width:2px

  %% Main pipeline nodes
  L[ABM Chapter Loader]
  V[ABM Block Schema Validator]
  R[ABM Mixed-Block Resolver]
  C[ABM Span Classifier]
  A[ABM Span Attribution]
  SP[ABM Style Planner]
  IT[ABM Span Iterator]
  CAST[ABM Span Casting]
  WU[ABM Utterance JSONL Writer]

  %% Artifact taps
  BJA[(blocks.jsonl)]
  SJA[(spans.jsonl)]
  SCA[(spans_cls.jsonl)]
  SAT[(spans_attr.jsonl)]
  SST[(spans_style.jsonl)]

  %% Main flow
  L -- blocks_data --> V -- validated_blocks --> R -- spans --> C -- spans_cls --> A -- spans_attr --> SP -- spans_style --> IT
  A -. spans_attr .-> CAST

  %% Writers
  IT -- current_span --> WU

  %% Artifact writes (optional)
  V -. write .-> BJA
  R -. write .-> SJA
  C -. write .-> SCA
  A -. write .-> SAT
  SP -. write .-> SST

  %% Classes
  class L,V,R,C,A,SP,IT,CAST core
  class BJA,SJA,SCA,SAT,SST art
  class WU out
